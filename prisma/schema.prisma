generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  name            String?
  role            Role     @default(STUDENT)
  stripeConnectId String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdCourses Course[]       @relation("CreatedCourses")
  enrollments    Enrollment[]
  purchases      Purchase[]
  progress       UserProgress[]
  Transaction    Transaction[]
  wallet         Wallet?
  comments       Comment[]
  quizAttempts   QuizAttempt[]
}

model Course {
  id          String  @id @default(uuid())
  title       String
  description String? @db.Text
  thumbnail   String?
  price       Float?
  isPublished Boolean @default(false)
  isApproved  Boolean @default(false)

  workload    Int?    // Represents the amount of hours of course
  instructorBio String? @db.Text

  instructorId String
  instructor   User   @relation("CreatedCourses", fields: [instructorId], references: [id], onDelete: Cascade)

  modules     Module[]
  enrollments Enrollment[]
  purchases   Purchase[]
  attachments Attachment[]

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  Transaction Transaction[]

  @@index([categoryId])
}

model Category {
  id      String   @id @default(uuid())
  name    String   @unique
  courses Course[]
}

model Module {
  id          String  @id @default(uuid())
  title       String
  position    Int
  isPublished Boolean @default(false)
  unlockDays  Int     @default(0) // 0 means instantly available

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  lessons Lesson[]
  quiz    Quiz?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

enum LessonType {
  VIDEO
  IN_PERSON
}

model Lesson {
  id          String     @id @default(uuid())
  title       String
  description String?    @db.Text
  videoUrl    String?
  type        LessonType @default(VIDEO)
  location    String?
  dateTime    DateTime?
  position    Int
  isPublished Boolean    @default(false)
  isFree      Boolean    @default(false)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  userProgress UserProgress[]
  comments     Comment[]
  muxData      MuxData?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([moduleId])
}

model Enrollment {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
}

model Purchase {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  price     Float
  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
}

model UserProgress {
  id       String @id @default(uuid())
  userId   String
  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId])
}

model Attachment {
  id   String @id @default(uuid())
  name String
  url  String @db.Text

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model Transaction {
  id     String @id @default(uuid())
  
  userId String // Student ID
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  instructorId String // Snapshot of instructor at time of transaction
  
  amount   Float
  currency String @default("BRL")

  originalAmount   Float?
  originalCurrency String?
  exchangeRate     Float?

  platformFeePercent Float @default(10) // e.g. 10.0 for 10%
  platformShare      Float
  instructorShare    Float

  paymentMethod   String @default("STRIPE") // STRIPE, PAYPAL, MBWAY
  stripePaymentId String? @unique // Made optional as it might be PayPal or others
  status          String @default("COMPLETED") // PENDING, COMPLETED, REFUNDED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([userId])
  @@index([instructorId])
}

model Wallet {
  id      String @id @default(uuid())
  
  instructorId String @unique
  instructor   User   @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  balance  Float @default(0)
  currency String @default("BRL")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MuxData {
  id String @id @default(uuid())
  assetId String
  playbackId String?

  lessonId String @unique
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model SystemSettings {
  id                String   @id @default(uuid())
  platformFeePercent Float    @default(10.0) // Percentage (e.g., 10.0 for 10%)
  
  heroTitle         String   @default("Master In-Demand Skills with Spero Academy")
  heroSubtitle      String   @db.Text @default("Whether you want to learn programming, design, or business, we connect you with expert instructors worldwide.")
  heroImage         String?  @db.Text

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Comment {
  id        String   @id @default(uuid())
  text      String   @db.Text
  isResolved Boolean @default(false)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lessonId])
  @@index([userId])
}

model Quiz {
  id          String   @id @default(uuid())
  title       String
  isPublished Boolean  @default(false)

  moduleId    String   @unique
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  questions   Question[]
  attempts    QuizAttempt[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Question {
  id            String   @id @default(uuid())
  prompt        String   @db.Text
  position      Int
  options       Json     // Array of { id, text, isCorrect } required format
  
  quizId        String
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([quizId])
}

model QuizAttempt {
  id          String   @id @default(uuid())
  score       Float
  isPassed    Boolean  @default(false)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([quizId])
}
